#-*- coding:utf8 -*-
import requests

def get_and_parse(url,headers,url_query_strint=None):
    resp = requests.get(url, headers=headers,params=url_query_string)
    parser = MYHTMLParser()
    parser.feed(resp.text)
    next_url,data = parser.result()
    return next_url,data
#print(resp.text)

from html.parser import HTMLParser
class MYHTMLParser(HTMLParser):
    def __init__(self):
        HTMLParser.__init__(self)
        self.begin = 0  #开始取网页标题和url
        self.flag = 0 #开始取下一页url
        self.each_url = ''
        self.next_url = ''
        self.content_dic = {}
    def handle_starttag(self, tag, attrs):
        if tag == 'h3':
            self.begin = self.begin + 1
        if tag == 'a' and self.begin == 1 :
            self.begin = self.begin + 1
            print("Start tag name_and_url :", tag)
            for attr in attrs:#print("     attr:", attr)
                if attr[0] == 'href' : 
                    print(attr[1])
                    self.each_url = attr[1]
        if tag == 'div' :
            for attr in attrs :
                if attr[0]=='id' and attr[1]=='page' :  self.flag += 1
        if tag == 'a' and self.flag == 1 :
            self.flag += 1
            print("Start tag next_url :", tag)
            for attr in attrs :
                if attr[0] == 'href' : self.next_url = attr[1]
    def handle_endtag(self, tag):
        if tag == 'h3' and self.begin == 1:
            self.begin -= 1
#            self.each_url = ''
        else : raise ValueError('h3-error')
        if tag == 'a' and self.begin == 2 :
            sefl.begin -= 1
            print("End tag name_and_url :", tag)
            self.content_dic[self.name_sum] = self.each_url
            self.name_sum = ''
        if tag == 'div' and self.flag == 1 : 
            self.flag -= 1 
        else : raise ValueError('div- error')
        if tag == 'a' and self.flag ==2 :
            self.flag -= 1
            print("End tag next_url :", tag)
    def handle_data(self, data):
        if self.begin == 2 : name_sum += data
        elif self.name_sum : print(name_sum)
        if self.flag = 2 and data != '下一页' : self.next_url = '' 
    def result(self):
        return next_url,content_dic

if __name__ == __main__ :
    url = 'http://www.baidu.com'
    url_query_string = {'wd':'福建 intitle:"邮政" -(管理)'}
    headers = {'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36'}
    next_url,data = get_and_parse(url+'/s?',headers,url_query_string)
    print(data,next_url)
#    while next_url:
#        next_url,data = get_and_parse(next_url,headers)
